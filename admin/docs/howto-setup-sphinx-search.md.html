<h3>Setup Sphinx Search with FSIP</h3>

<p>FSIP includes built-in support for the <a href="http://sphinxsearch.com">Sphinx search engine server</a>, which runs on your own server to process ultrafast, relevancy-based searches. Sphinx is superior to traditional SQL-based searches, because it can sort results by relevancy, search using related terms, and rapidly comb large datasets.</p>

<p><strong>Note: This article is technically complex and presumes you have knowledge of the command line.</strong> It is intended for system administrators and similarly technically-savvy individuals, and is not for the faint of heart. Please read this entire document before deciding whether Sphinx is right for you or your organization.</p>

<p>To get Sphinx and FSIP running in tandem, you will need a VPS or dedicated server and root (SSH) access.</p>

<h6>1. Download and install Sphinx.</h6>

<p>Sphinx is free and open source. You can download it one of two ways. First, check your operating system&#8217;s package management utility, such as <code>apt-get</code> or <code>yum</code>, for a readymade copy of Sphinx.</p>

<p>Otherwise, if Sphinx is unavailable, download the latest stable version of <a href="http://sphinxsearch.com/downloads/">Sphinx</a>. FSIP has been tested with Sphinx 0.9.9 and Sphinx 2.0.1, and works well with either. Follow the instructions that came with your copy of Sphinx to install it.</p>

<p>Next, download and install the <a href="http://pecl.php.net/package/sphinx">PHP PECL Sphinx package</a>. If you already have <a href="http://pear.php.net/">PHP PEAR</a> installed, which many do, you should be able to install the PHP PECL Sphinx package by running this command: <code>pecl install sphinx</code>. If that is successful, continue. Otherwise, <a href="http://pear.php.net/manual/en/installation.introduction.php">install PHP PEAR</a> and then issue the command above.</p>

<p>You can ensure SphinxÂ has been installed by choosing <strong>Settings</strong> in FSIP and looking under the &#8220;Environment&#8221; header.</p>

<h6>2. Configure Sphinx.</h6>

<p>Next, we need to tell Sphinx where to access and how to process the data in FSIP. Locate Sphinx&#8217;s configuration file (usually <code>/etc/sphinx/sphinx.conf</code>) and open it. Here&#8217;s an example configuration:</p>

<pre><code>source fsip
{
    type                = xmlpipe2
    xmlpipe_command     = php /usr/local/html/admin/sphinx-xmlpipe2.php
}

index my_site
{
    source          = fsip
    path            = /var/lib/sphinx/my_site
    docinfo         = extern
    charset_type    = utf-8
    morphology      = stem_en
}
</code></pre>

<p>Let&#8217;s take a look at this file. There are two components: an index and a source. The source is where your data is coming from. The index is what will be searched (and derives its data from one or more sources).</p>

<p>Our first (and only) source will be FSIP:</p>

<ol>
<li><code>type = xmlpipe2</code>

<ul>
<li>FSIP sends its contents to Sphinx in an XML-based format</li>
</ul></li>
<li><code>xmlpipe_command = php /usr/local/html/admin/sphinx-xmlpipe2.php</code>

<ul>
<li>To locate FSIP&#8217;s contents, run the PHP file located at <code>/your_web_root/admin/sphinx-xmlpipe2.php</code></li>
<li>Be sure to change the root to the directory where FSIP is installed</li>
</ul></li>
</ol>

<p>Our index will contain our one source:</p>

<ol>
<li><code>source = fsip</code>

<ul>
<li>Include the source named <code>fsip</code></li>
</ul></li>
<li><code>path = /var/lib/sphinx/my_site</code>

<ul>
<li>Store (and retrieve) the index from this location on my server</li>
<li>Make sure Sphinx has sufficient privileges to read and write from this location</li>
</ul></li>
<li><code>docinfo = extern</code>

<ul>
<li><em>(Optional)</em> Affects RAM usage, <code>extern</code> is the default</li>
</ul></li>
<li><code>charset_type = utf-8</code>

<ul>
<li><em>(Optional)</em> Tell Sphinx to use Unicode character encoding</li>
</ul></li>
<li><code>morphology = stem_en</code>

<ul>
<li><em>(Optional)</em> Tell Sphinx to normalize words (e.g., when searching &#8220;dog&#8221;, results would include &#8220;dogs&#8221; and vice-versa)</li>
<li>Replace or remove this variable if your content is not in English</li>
</ul></li>
</ol>

<p>Save the file.</p>

<h6>3. Start Sphinx.</h6>

<p>Like a Web server such as Apache or a database server such as MySQL, Sphinx is a <em>search</em> server. Its daemon must be running continuously to accept and process searches. Start Sphinx now. Also, make sure Sphinx is loaded when your Web server is restarted.</p>

<h6>4. Prepare FSIP.</h6>

<p>Go to <strong>Dashboard > Settings > Maintenance > &#8220;Build items table&#8221;</strong> and wait for the task to complete. You have just created a new documents table that Sphinx and FSIP can reference to locate the results.</p>

<h6>5. Test Sphinx</h6>

<p>From the command line, you should now be able to search FSIP. First, tell Sphinx to create its first index: <code>indexer --all --rotate;</code>. Then, try a word you know you&#8217;ve used on your FSIP-powered Web site, for example <code>search "New York"</code>. Sphinx should list one or more results.</p>

<h6>6. Set up a Cron job.</h6>

<p>In most cases, including this one, Sphinx does not index content in real-time. You must reindex your content at a regular interval to keep the search results up to date. Luckily, this is very easy to do. Cron is a way to tell your server to perform an action at regular intervals. A job is a task to be executed at one of these intervals. Here&#8217;s a sample shell script named <code>build-sphinx.sh</code> that we will use in our Cron job:</p>

<pre><code>php -f /usr/local/nginx/html/admin/tasks/build-items-job.php;
indexer --all --rotate;
</code></pre>

<p><em>Note: A shell script is just a list of commands that are the same as if you typed them into the shell yourself.</em></p>

<p>Save this file on your Web server, anywhere that is not publicly accessible. The first line tells FSIP to update its documents table. The second line tells Sphinx that new content should be added to its index.</p>

<p>You can choose to run this script as often as you wish. We recommend once every 20 minutes. Here&#8217;s our Cron entry:</p>

<pre><code>05,25,45 * * * * /path_to_your_script_from_above/build-sphinx.sh &gt;/dev/null 2&gt;&amp;1
</code></pre>

<p>You can use the command <code>crontab -e</code> to edit your Cron configuration and add the line above. This line tells Cron to execute the script on the 5th, 25th, and 45th minute of every hour, every day, etc. It also says where to find the script, and the last two parts simply tell Cron to ignore any output that may be generated.</p>

<h6>7. Tell FSIP to use Sphinx.</h6>

<p>Now that you&#8217;ve got Sphinx up and running, you need to notify FSIP that Sphinx is installed, configured, and ready for use. Go to <strong>Dashboard > Settings > Configuration</strong>. Scroll down to the &#8220;Sphinx&#8221; header and click &#8220;Use Sphinx to process search queries&#8221;. Save your configuration.</p>

<h6>8. Make sure it works.</h6>

<p>Ensure that FSIP is delivering the search results you were expecting it to. You may want to turn it on and off and compare the results from traditional results to Sphinx results. If the results are not what you were expecting, you can disable Sphinx in the FSIP configuration pane while you fine-tune Sphinx for your Web site&#8217;s content.</p>
